trigger:
  - develop

pool:
  vmImage: 'ubuntu-latest' # <--- CRITICAL: Must use Linux to generate Linux binaries

variables:
  azureSubscription: 'agora-current-sc'
  apiAppName: 'agora-api-dev'
  webAppName: 'agora-web-dev'

stages:
# ==========================================================
# STAGE 1: SMART CHANGE DETECTION
# ==========================================================
- stage: CheckChanges
  displayName: 'Analyze Changed Paths'
  jobs:
  - job: Check
    displayName: 'Check Git Diff'
    steps:
    - checkout: self
      fetchDepth: 0 

    - pwsh: |
        Write-Host "Checking for changes..."
        try {
            $changes = git diff --name-only origin/develop..HEAD
        } catch {
            Write-Host "Git diff failed, defaulting to DEPLOY ALL."
            $changes = "apps/api apps/web azure-pipelines.yml"
        }
        
        if (-not $changes) {
            $changes = git show --name-only --format= HEAD
        }

        Write-Host "Files changed: $changes"

        $apiChanged = "false"
        $webChanged = "false"

        if ($changes -match "apps/api" -or $changes -match "packages" -or $changes -match "azure-pipelines.yml") {
            $apiChanged = "true"
            Write-Host ">> Detected changes for API."
        }

        if ($changes -match "apps/web" -or $changes -match "packages" -or $changes -match "azure-pipelines.yml") {
            $webChanged = "true"
            Write-Host ">> Detected changes for Web."
        }

        Write-Host "##vso[task.setvariable variable=apiChanged;isOutput=true]$apiChanged"
        Write-Host "##vso[task.setvariable variable=webChanged;isOutput=true]$webChanged"
      name: CheckStep

# ==========================================================
# STAGE 2: BACKEND DEPLOY (API)
# ==========================================================
- stage: Backend
  displayName: 'Deploy Backend (API)'
  dependsOn: CheckChanges
  condition: or(eq(dependencies.CheckChanges.outputs['Check.CheckStep.apiChanged'], 'true'), eq(variables['Build.Reason'], 'Manual'))
  variables:
    workingDir: 'apps/api'
  jobs:
  - job: BuildAndDeployAPI
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
    
    # 1. Install at ROOT (Linux Agent = Linux Binaries)
    - script: npm ci
      workingDirectory: . 
      displayName: 'Install Dependencies (Root)'

    # 2. Generate Prisma Client
    - script: npx prisma generate --schema=packages/database/prisma/schema.prisma
      workingDirectory: .
      displayName: 'Generate Prisma Client'

    # 3. Disable Strict Mode (Bash version for Linux)
    - bash: |
        path="apps/api/tsconfig.json"
        if [ -f "$path" ]; then
            # Use node to manipulate JSON safely
            node -e "
                const fs = require('fs');
                const tsconfig = JSON.parse(fs.readFileSync('$path'));
                if (!tsconfig.compilerOptions) tsconfig.compilerOptions = {};
                tsconfig.compilerOptions.strict = false;
                tsconfig.compilerOptions.noImplicitAny = false;
                tsconfig.compilerOptions.skipLibCheck = true;
                fs.writeFileSync('$path', JSON.stringify(tsconfig, null, 2));
            "
            echo "Disabled strict mode in tsconfig.json"
        fi
      displayName: 'Disable Strict TypeScript Checks'

    # 4. Build the API
    - script: npm run build
      workingDirectory: $(workingDir)
      displayName: 'Build NestJS'
      env:
        NODE_OPTIONS: '--max-old-space-size=4096'

    # 5. Prune Dev Dependencies
    - script: npm prune --production
      workingDirectory: .
      displayName: 'Prune Dev Dependencies'

    # 6. ASSEMBLE DEPLOYMENT (Linux)
    - bash: |
        ROOT=$(Build.SourcesDirectory)
        DEPLOY_DIR=$ROOT/deploy_api
        
        echo "Preparing deployment package at $DEPLOY_DIR..."
        rm -rf $DEPLOY_DIR
        mkdir -p $DEPLOY_DIR

        # A. Copy package.json
        cp $ROOT/apps/api/package.json $DEPLOY_DIR/

        # B. Find and copy compiled main.js
        MAIN_FILE=$(find $ROOT -type f -name "main.js" | grep "/dist/" | head -n 1)
        
        if [ -z "$MAIN_FILE" ]; then
            echo "##vso[task.logissue type=error]CRITICAL: Could not find 'main.js' build artifact."
            exit 1
        fi

        echo "Found compiled entry point at: $MAIN_FILE"
        SOURCE_DIR=$(dirname "$MAIN_FILE")
        mkdir -p $DEPLOY_DIR/dist
        cp -r $SOURCE_DIR/* $DEPLOY_DIR/dist/

        # C. Copy node_modules (Dereference symlinks to include local packages)
        echo "Copying node_modules..."
        cp -r -L $ROOT/node_modules $DEPLOY_DIR/
        
        echo "Artifact assembly complete."
      displayName: 'Assemble Deployment Package'

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)/deploy_api'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/api.zip'
        replaceExistingArchive: true

    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux'
        appName: $(apiAppName)
        package: '$(Build.ArtifactStagingDirectory)/api.zip'
        startUpCommand: 'node dist/main'

# ==========================================================
# STAGE 3: FRONTEND DEPLOY (WEB) 
# ==========================================================
- stage: Frontend
  displayName: 'Deploy Frontend'
  dependsOn: CheckChanges
  condition: or(eq(dependencies.CheckChanges.outputs['Check.CheckStep.webChanged'], 'true'), eq(variables['Build.Reason'], 'Manual'))
  variables:
    workingDir: 'apps/web'
  jobs:
  - job: BuildAndDeployWeb
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'

    - script: npm ci
      workingDirectory: $(workingDir)
      displayName: 'Install Dependencies'

    - pwsh: |
        if ([string]::IsNullOrEmpty($env:NEXT_PUBLIC_API_URL)) {
          Write-Host "##vso[task.logissue type=warning]NEXT_PUBLIC_API_URL is not set."
        } else {
          Write-Host "NEXT_PUBLIC_API_URL is set."
        }
      displayName: 'Verify Environment Variables'
      env:
        NEXT_PUBLIC_API_URL: $(NEXT_PUBLIC_API_URL)

    - script: npm run build -- --no-lint
      workingDirectory: $(workingDir)
      displayName: 'Build Next.js App (No Lint)'
      env:
        NEXT_PUBLIC_API_URL: $(NEXT_PUBLIC_API_URL)

    - bash: |
        echo "Copying static assets..."
        cp -r public .next/standalone/apps/web/
        mkdir -p .next/standalone/apps/web/.next
        cp -r .next/static .next/standalone/apps/web/.next/
      workingDirectory: $(workingDir)
      displayName: 'Copy Static Assets to Standalone'

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(workingDir)/.next/standalone' 
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/web.zip'
        replaceExistingArchive: true

    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux'
        appName: $(webAppName)
        package: '$(Build.ArtifactStagingDirectory)/web.zip'
        startUpCommand: 'node apps/web/server.js'